<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fun House: Vibrate Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --wa-green: #25D366; --wa-dark: #075E54; --truth: #34B7F1; --dare: #e91e63; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--wa-dark); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; }
        .card { background: white; padding: 20px; border-radius: 25px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        .lobby-info { background: #f1f8ff; padding: 12px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #007bff; }
        .id-badge { font-size: 1.4rem; font-weight: 900; color: #007bff; letter-spacing: 2px; }
        .game-area { position: relative; width: 260px; height: 260px; margin: 20px auto; border-radius: 50%; border: 8px solid #333; background: #fff; }
        #wheel { width: 100%; height: 100%; border-radius: 50%; position: absolute; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); }
        #bottle { position: absolute; top: 50%; left: 50%; width: 16px; height: 150px; background: #222; margin-top: -75px; margin-left: -8px; border-radius: 10px; z-index: 10; pointer-events: none; }
        #bottle::after { content: 'üçæ'; position: absolute; top: -15px; left: -10px; font-size: 34px; transform: rotate(-45deg); }
        .name-label { position: absolute; font-weight: bold; font-size: 11px; z-index: 15; background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; transform: translate(-50%, -50%); }
        .btn { border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; padding: 16px; font-size: 1rem; }
        #spinBtn { background: var(--wa-green); color: white; display: none; box-shadow: 0 5px 0 #128C7E; }
        #resultBox { margin-top: 15px; padding: 15px; border-radius: 15px; background: #fffde7; display: none; border: 2px solid #fbc02d; animation: pop 0.4s ease; }
        .type-pill { display: inline-block; padding: 4px 12px; border-radius: 10px; color: white; font-size: 0.8rem; margin-bottom: 5px; }
        @keyframes pop { from { transform: scale(0.8); opacity:0; } to { transform: scale(1); opacity:1; } }
    </style>
</head>
<body>

<div class="card">
    <div id="setupView">
        <h2 style="color:var(--wa-dark)">Fun House Live</h2>
        <button class="btn" style="background:var(--truth); color:white;" onclick="startHost()">HOST GAME</button>
        <button class="btn" style="background:#333; color:white;" onclick="startPlayer()">JOIN GAME</button>
    </div>

    <div id="mainGame" style="display:none;">
        <div class="lobby-info">
            <div id="connMsg" style="font-size:0.8rem;">INITIALIZING...</div>
            <div id="idCode" class="id-badge">----</div>
        </div>
        <button class="btn" id="addBtn" style="background:#333; color:white;" onclick="hAdd()">‚ûï ADD PLAYER</button>
        <button class="btn" id="spinBtn" onclick="bSpin()">SPIN FOR ALL üçæ</button>
        <div class="game-area">
            <div id="wheel"></div>
            <div id="bottle"></div>
        </div>
        <div id="resultBox">
            <div id="tType" class="type-pill"></div>
            <div id="vName" style="font-size: 1.6rem; font-weight: 900; color: #c62828;"></div>
            <p id="tText" style="font-style: italic; font-weight: bold; margin: 10px 0;"></p>
        </div>
    </div>
</div>

<script>
    let peer, conn, players = [], rotation = 0, isHost = false, myName = "";
    const conns = [];
    const ts = ["Secret crush?", "Ever lied to the group?", "Biggest ick?", "Best looking here?"];
    const ds = ["Sing a song.", "Post a selfie.", "Text an ex.", "Show browser history."];

    function startHost() {
        isHost = true; myName = prompt("Your Name:");
        if(!myName) return; players.push(myName);
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer('fun-' + id);
        peer.on('open', () => { showG(id, "Hosting: Give code to friends!"); document.getElementById('spinBtn').style.display='block'; draw(); });
        peer.on('connection', (c) => { 
            conns.push(c); 
            c.on('data', (d) => { if(d.type==='join'){ players.push(d.name); draw(); conns.forEach(cc=>cc.send({type:'sync', p:players})); }});
            c.on('open', () => c.send({type:'sync', p:players}));
        });
    }

    function startPlayer() {
        myName = prompt("Your Name:"); if(!myName) return;
        const id = prompt("Enter 4-Digit ID:");
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('fun-' + id);
            conn.on('open', () => { showG(id, "Connected! Wait for Host."); conn.send({type:'join', name:myName}); document.getElementById('addBtn').style.display='none'; });
            conn.on('data', (d) => { if(d.type==='sync'){ players=d.p; draw(); } if(d.type==='spin'){ rotation=d.rot; runS(d); }});
        });
    }

    function showG(id, m) { document.getElementById('setupView').style.display='none'; document.getElementById('mainGame').style.display='block'; document.getElementById('idCode').innerText=id; document.getElementById('connMsg').innerText=m; }
    function hAdd() { const n=prompt("Name:"); if(n){ players.push(n); draw(); conns.forEach(c=>c.send({type:'sync', p:players})); }}

    function draw() {
        const w = document.getElementById('wheel'); w.innerHTML = '';
        const step = 360 / players.length;
        players.forEach((p, i) => {
            const a = (i * step + step/2) * (Math.PI/180);
            const x = 130 + 85 * Math.cos(a - Math.PI/2);
            const y = 130 + 85 * Math.sin(a - Math.PI/2);
            const l = document.createElement('div'); l.className='name-label'; l.style.left=x+'px'; l.style.top=y+'px'; l.innerText=p;
            w.appendChild(l);
        });
        w.style.background = `conic-gradient(${players.map((_,i)=>`${i%2===0?'#fff':'#f2f2f2'} ${i*step}deg ${(i+1)*step}deg`).join(',')})`;
    }

    function bSpin() {
        const idx = Math.floor(Math.random()*players.length);
        const isT = Math.random()>0.5;
        const task = (isT?ts:ds)[Math.floor(Math.random()*4)];
        const step = 360/players.length;
        const newR = rotation + 1800 + (idx*step + step/2);
        const data = { type:'spin', rot:newR, v:players[idx], t:task, isT:isT };
        conns.forEach(c => c.send(data)); runS(data);
    }

    function runS(d) {
        document.getElementById('resultBox').style.display='none';
        document.getElementById('wheel').style.transform = `rotate(-${d.rot}deg)`;
        setTimeout(() => {
            document.getElementById('vName').innerText = d.v;
            document.getElementById('tText').innerText = `"${d.t}"`;
            const p = document.getElementById('tType');
            p.innerText = d.isT ? "TRUTH" : "DARE";
            p.style.background = d.isT ? "var(--truth)" : "var(--dare)";
            document.getElementById('resultBox').style.display='block';
            rotation = d.rot;
            // VIBRATE IF IT IS YOU
            if (d.v.toLowerCase() === myName.toLowerCase()) {
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        }, 4000);
    }
</script>
</body>
</html>
