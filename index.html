<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fun House: Floating Privacy</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --wa-green: #25D366; --truth: #34B7F1; --dare: #ff4757; --gold: #ffa502; }
        * { -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; color: white; overflow: hidden; }
        
        #panicOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; color: #333; z-index: 10000; display: none; padding: 40px; font-family: 'Times New Roman', serif; text-align: left; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 30px; width: 100%; max-width: 420px; text-align: center; border: 1px solid #333; position: relative; }
        .game-box { position: relative; width: 240px; height: 240px; margin: 15px auto; border-radius: 50%; border: 6px solid #444; background: #fff; }
        
        #bottle { 
            position: absolute; top: 50%; left: 50%; width: 22px; height: 140px; 
            background: #111; margin-top: -70px; margin-left: -11px; border-radius: 15px; 
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1); z-index: 10;
        }
        #bottle::after { content: 'üçæ'; position: absolute; top: -15px; left: -10px; font-size: 40px; transform: rotate(-45deg); }
        .name-label { position: absolute; font-weight: 900; font-size: 11px; color: #000; transform: translate(-50%, -50%); width: 70px; text-align: center; }

        .hidden-task { background: #000; color: #000; padding: 15px; border-radius: 15px; cursor: pointer; border: 2px dashed var(--gold); }
        .btn { border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 8px; padding: 14px; font-size: 1rem; }
        
        #chatBubble { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--gold); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; z-index: 999; }
        #chatPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; padding: 20px; }
        #msgContainer { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; text-align: left; }
        #resultBox { margin-top: 10px; padding: 15px; border-radius: 20px; background: #fff; color: #000; display: none; border: 4px solid var(--gold); }
    </style>
</head>
<body id="gameBody">

<div id="panicOverlay" onclick="this.style.display='none'">
    <h1 style="border-bottom: 2px solid #333;">Weather & Global News</h1>
    <p>Atmospheric shifts are being recorded across the Atlantic...</p>
    <p style="color: #666; font-style: italic;">Tap to return.</p>
</div>

<div class="card" id="mainCard">
    <div id="status" style="font-size: 0.8rem; color: var(--gold); margin-bottom: 10px;">VIRTUAL PRIVACY MODE</div>
    
    <div id="setupControls">
        <button class="btn" style="background:var(--gold); color:black;" onclick="initHost()">üöÄ START AS HOST</button>
    </div>

    <div id="gameUI" style="display:none;">
        <div id="hostControls" style="display:none;">
            <button class="btn" style="background:#333; color:white; width: 48%; display: inline-block;" onclick="addPlayerManual()">‚ûï ADD</button>
            <button class="btn" style="background:#cc0000; color:white; width: 48%; display: inline-block;" onclick="resetGame()">üßπ RESET</button>
            <button class="btn" style="background:var(--wa-green); color:white;" onclick="sendInvite()">üîó WHATSAPP INVITE</button>
            <button class="btn" id="spinBtn" style="background:var(--dare); color:white; display:none;" onclick="triggerSyncSpin()">SPIN BOTTLE üçæ</button>
        </div>

        <div class="game-box" id="arena"><div id="bottle"></div></div>

        <div id="resultBox">
            <b id="vName" style="font-size:1.4rem;"></b><br>
            <p style="font-size:0.75rem; color:#666; margin:5px 0;">(HOLD BOX TO REVEAL)</p>
            <div class="hidden-task" id="vTask">...</div>
        </div>
    </div>
</div>

<div id="chatBubble" onclick="toggleChat()">üí¨</div>

<div id="chatPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="color:var(--gold); margin:0;">Group Chat</h2>
        <button onclick="toggleChat()" style="background:none; border:none; color:white; font-size:2rem;">&times;</button>
    </div>
    <div id="msgContainer"></div>
    <input type="text" id="chatInput" placeholder="Type a message..." style="width:100%; padding:15px; border-radius:12px; background:#333; color:white; border:none; margin-bottom:10px;">
    <button class="btn" style="background:var(--truth); color:white;" onclick="sendChat()">SEND</button>
</div>

<script>
    let peer, conn, players = [], isHost = false, rotation = 0, myName = "";
    const conns = [];
    const tasks = ["Show Private Tabs", "Last Deleted Photo", "WhatsApp Search History", "Show Battery Usage", "Last Voice Note", "Open Instagram DMs"];

    // Triple tap panic
    let tapCount = 0;
    document.body.onclick = (e) => {
        if(e.target.id === 'gameBody' || e.target.id === 'mainCard') {
            tapCount++;
            setTimeout(() => tapCount = 0, 400);
            if(tapCount === 3) document.getElementById('panicOverlay').style.display = 'block';
        }
    };

    function setupUI(id) {
        document.getElementById('setupControls').style.display = 'none';
        document.getElementById('gameUI').style.display = 'block';
        document.getElementById('status').innerText = "ROOM ID: " + id;
        if(isHost) document.getElementById('hostControls').style.display = 'block';
    }

    function initHost() {
        const n = prompt("Your Name:");
        if(!n) return;
        myName = n.trim();
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        
        peer = new Peer('fh-' + id);
        peer.on('open', () => {
            players.push(myName);
            setupUI(id);
            draw();
        });

        peer.on('connection', (c) => {
            conns.push(c);
            c.on('data', (data) => {
                if(data.type === 'join') {
                    if(!players.includes(data.n)) players.push(data.n);
                    bcast({type:'sync', p:players});
                    draw();
                }
                if(data.type === 'chat') { bcast(data); addMsg(data.u, data.m); }
            });
        });
    }

    function initPlayer(id) {
        const n = prompt("Your Name:");
        if(!n) return;
        myName = n.trim();
        
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('fh-' + id);
            conn.on('open', () => {
                setupUI(id);
                conn.send({type:'join', n:myName});
            });
            conn.on('data', (data) => {
                if(data.type === 'sync') { players = data.p; draw(); }
                if(data.type === 'spin') runSpin(data);
                if(data.type === 'chat') addMsg(data.u, data.m);
            });
        });
    }

    function resetGame() {
        if(!confirm("Clear all players and start over?")) return;
        players = [myName];
        draw();
        bcast({type:'sync', p:players});
        document.getElementById('msgContainer').innerHTML = "";
        document.getElementById('resultBox').style.display = 'none';
    }

    function addPlayerManual() {
        const n = prompt("New Player Name:");
        if(n) {
            players.push(n.trim());
            draw();
            if(isHost) bcast({type:'sync', p:players});
        }
    }

    function triggerSyncSpin() {
        const idx = Math.floor(Math.random() * players.length);
        const task = tasks[Math.floor(Math.random() * tasks.length)];
        const step = 360 / players.length;
        rotation += (360 * 5) + (360 - (rotation % 360)) + (idx * step);
        const d = { type:'spin', rot:rotation, idx:idx, t:task };
        bcast(d); 
        runSpin(d);
    }

    function runSpin(d) {
        document.getElementById('resultBox').style.display='none';
        document.getElementById('bottle').style.transform = `rotate(${d.rot}deg)`;
        setTimeout(() => {
            document.getElementById('vName').innerText = players[d.idx];
            document.getElementById('vTask').innerText = d.t;
            document.getElementById('resultBox').style.display='block';
            if(players[d.idx].toLowerCase() === myName.toLowerCase()) {
                if(navigator.vibrate) navigator.vibrate([400, 100, 400]);
            }
        }, 4000);
    }

    function draw() {
        const arena = document.getElementById('arena');
        document.querySelectorAll('.name-label').forEach(e => e.remove());
        players.forEach((n, i) => {
            const a = (i * (360/players.length)) * (Math.PI/180);
            const x = 120 + 95 * Math.cos(a - Math.PI/2);
            const y = 120 + 95 * Math.sin(a - Math.PI/2);
            const l = document.createElement('div');
            l.className = 'name-label'; l.style.left = x+'px'; l.style.top = y+'px'; l.innerText = n;
            arena.appendChild(l);
        });
        if(isHost && players.length >= 2) document.getElementById('spinBtn').style.display='block';
    }

    function bcast(d) { conns.forEach(c => { if(c.open) c.send(d); }); }
    function toggleChat() { const p = document.getElementById('chatPanel'); p.style.display = p.style.display === 'flex' ? 'none' : 'flex'; }
    function sendChat() { 
        const i = document.getElementById('chatInput'); if(!i.value) return;
        const d = {type:'chat', u:myName, m:i.value};
        if(isHost) bcast(d); else conn.send(d);
        addMsg(myName, i.value); i.value = "";
    }
    function addMsg(u, m) { document.getElementById('msgContainer').innerHTML += `<div><b>${u}:</b> ${m}</div>`; }
    function sendInvite() { window.open(`https://wa.me/?text=${encodeURIComponent(window.location.origin + window.location.pathname + "?join=" + peer.id.replace('fh-',''))}`); }

    window.onload = () => {
        const urlId = new URLSearchParams(window.location.search).get('join');
        if(urlId) initPlayer(urlId);
    };
</script>
</body>
</html>
