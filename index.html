<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fun House: Exclusive WA Group</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --wa-green: #25D366; --truth: #34B7F1; --dare: #ff4757; --gold: #ffa502; }
        * { -webkit-user-select: none; user-select: none; box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; color: white; overflow: hidden; }
        
        #panicOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; color: #333; z-index: 10000; display: none; padding: 40px; font-family: 'Times New Roman', serif; text-align: left; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 30px; width: 100%; max-width: 420px; text-align: center; border: 1px solid #333; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .game-box { position: relative; width: 240px; height: 240px; margin: 15px auto; border-radius: 50%; border: 6px solid #444; background: #fff; }
        
        #bottle { 
            position: absolute; top: 50%; left: 50%; width: 22px; height: 140px; 
            background: #111; margin-top: -70px; margin-left: -11px; border-radius: 15px; 
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1); z-index: 10;
        }
        #bottle::after { content: 'üçæ'; position: absolute; top: -15px; left: -10px; font-size: 40px; transform: rotate(-45deg); }
        
        .name-label { position: absolute; font-weight: 900; font-size: 11px; color: #000; transform: translate(-50%, -50%); width: 85px; text-align: center; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; background: #888; }
        .online { background: var(--wa-green) !important; box-shadow: 0 0 8px var(--wa-green); }

        .hidden-task { background: #000; color: #000; padding: 15px; border-radius: 15px; cursor: pointer; border: 2px dashed var(--gold); margin-bottom: 10px; }
        .btn { border: none; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 8px; padding: 14px; font-size: 1rem; transition: 0.3s; }
        .btn:disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }
        
        #chatBubble { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--gold); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; z-index: 999; }
        #chatPanel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 1000; display: none; flex-direction: column; padding: 20px; }
        #msgContainer { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; text-align: left; }
        #resultBox { margin-top: 10px; padding: 15px; border-radius: 20px; background: #fff; color: #000; display: none; border: 4px solid var(--gold); animation: popIn 0.3s ease; }
        @keyframes popIn { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }
    </style>
</head>
<body id="gameBody">

<div id="panicOverlay" onclick="this.style.display='none'">
    <h1>Quarterly Audit Report</h1>
    <p>Viewing end-to-end encrypted protocol data for internal review...</p>
</div>

<div class="card" id="mainCard">
    <div id="status" style="font-size: 0.8rem; color: var(--gold); margin-bottom: 10px;">GROUP PRIVACY ACTIVE</div>
    
    <div id="setupControls">
        <button class="btn" style="background:var(--gold); color:black;" onclick="initHost()">üöÄ START AS HOST</button>
    </div>

    <div id="gameUI" style="display:none;">
        <div id="hostControls" style="display:none;">
            <div style="display:flex; gap:5px;">
                <button class="btn" style="background:#333; color:white;" onclick="addPlayerManual()">‚ûï ADD</button>
                <button class="btn" style="background:#cc0000; color:white;" onclick="resetGame()">üßπ RESET</button>
            </div>
            <button class="btn" style="background:var(--wa-green); color:white;" onclick="sendInvite()">üîó INVITE GROUP TO APP</button>
            <div id="spinPrompt" style="font-size: 0.75rem; color: #ff4757; margin-top: 8px; font-weight: bold;">Waiting for players...</div>
            <button class="btn" id="spinBtn" style="background:var(--dare); color:white; display:none;" onclick="triggerSyncSpin()" disabled>SPIN BOTTLE üçæ</button>
        </div>

        <div class="game-box" id="arena"><div id="bottle"></div></div>

        <div id="resultBox">
            <b id="vName" style="font-size:1.4rem;"></b><br>
            <div class="hidden-task" id="vTask" onmousedown="showT()" onmouseup="hideT()" ontouchstart="showT()" ontouchend="hideT()">...</div>
            <div id="playerActions"></div>
        </div>
    </div>
</div>

<div id="chatBubble" onclick="toggleChat()">üí¨</div>
<div id="chatPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="color:var(--gold); margin:0;">In-Game Chat</h2>
        <button onclick="toggleChat()" style="background:none; border:none; color:white; font-size:2rem;">&times;</button>
    </div>
    <div id="msgContainer"></div>
    <input type="text" id="chatInput" placeholder="Message..." style="width:100%; padding:15px; border-radius:12px; background:#333; color:white; border:none; margin-bottom:10px;">
    <button class="btn" style="background:var(--truth); color:white;" onclick="sendChat()">SEND</button>
</div>

<script>
    let peer, conn, players = [], activePlayers = [], isHost = false, rotation = 0, myName = "";
    const conns = [];
    
    // HARDCODED GROUP LINK
    const WA_GROUP_URL = "https://chat.whatsapp.com/LlVuUQytOKBFtOL1Fw0hEM";

    const tasks = [
        "üì∏ Screenshot your WhatsApp Chat list and post to group.",
        "üìú Forward the 5th message in your 'Archived' to the group.",
        "üé§ Record a 10s voice note saying 'I have a secret' and post it.",
        "üñºÔ∏è Change your WhatsApp Status to 'I am a Bottle Spin victim' for 5 mins.",
        "üì± Share your WhatsApp 'Linked Devices' screen to the group.",
        "üí¨ Find the last person you muted and tell the group why.",
        "üîç Search the word 'Sexy' in your WhatsApp and show results.",
        "üë• Show the group your 'Frequently Contacted' list."
    ];

    let tapCount = 0;
    document.body.onclick = (e) => { if((e.target.id === 'gameBody' || e.target.id === 'mainCard') && ++tapCount === 3) document.getElementById('panicOverlay').style.display = 'block'; setTimeout(()=>tapCount=0, 400); };

    function showT() { const t=document.getElementById('vTask'); t.style.background="transparent"; t.style.color="white"; }
    function hideT() { const t=document.getElementById('vTask'); t.style.background="#000"; t.style.color="#000"; }

    function setupUI(id) {
        document.getElementById('setupControls').style.display = 'none';
        document.getElementById('gameUI').style.display = 'block';
        document.getElementById('status').innerText = "SESSION ID: " + id;
        if(isHost) document.getElementById('hostControls').style.display = 'block';
    }

    function initHost() {
        const n = prompt("Your Name:"); if(!n) return;
        myName = n.trim(); isHost = true;
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer('fh-' + id);
        peer.on('open', () => { players.push(myName); activePlayers.push(myName); setupUI(id); draw(); });
        peer.on('connection', (c) => {
            conns.push(c);
            c.on('data', (d) => {
                if(d.type === 'join') {
                    if(!players.includes(d.n)) players.push(d.n);
                    if(!activePlayers.includes(d.n)) activePlayers.push(d.n);
                    bcast({type:'sync', p:players, a:activePlayers}); draw();
                }
                if(d.type === 'chat') { bcast(d); addMsg(d.u, d.m); }
                if(d.type === 'unlock') unlockSpin();
            });
        });
    }

    function initPlayer(id) {
        const n = prompt("Your Name:"); if(!n) return;
        myName = n.trim();
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('fh-' + id);
            conn.on('open', () => { setupUI(id); conn.send({type:'join', n:myName}); });
            conn.on('data', (d) => {
                if(d.type === 'sync') { players = d.p; activePlayers = d.a; draw(); }
                if(d.type === 'spin') runSpin(d);
                if(d.type === 'chat') addMsg(d.u, d.m);
            });
        });
    }

    function addPlayerManual() {
        const n = prompt("Player Name:");
        if(n && !players.includes(n.trim())) { players.push(n.trim()); draw(); if(isHost) bcast({type:'sync', p:players, a:activePlayers}); }
    }

    function draw() {
        const arena = document.getElementById('arena');
        document.querySelectorAll('.name-label').forEach(e => e.remove());
        const step = 360 / players.length;
        players.forEach((n, i) => {
            const a = (i * step) * (Math.PI/180);
            const x = 120 + 95 * Math.cos(a - Math.PI/2);
            const y = 120 + 95 * Math.sin(a - Math.PI/2);
            const l = document.createElement('div');
            l.className = 'name-label'; l.style.left = x+'px'; l.style.top = y+'px';
            const dot = activePlayers.includes(n) ? 'online' : '';
            l.innerHTML = `<span class="status-dot ${dot}"></span>${n}`;
            arena.appendChild(l);
        });

        if(isHost) {
            const btn = document.getElementById('spinBtn');
            const ready = players.length >= 2 && players.every(p => activePlayers.includes(p));
            btn.style.display = 'block'; btn.disabled = !ready;
            document.getElementById('spinPrompt').innerText = ready ? "Ready!" : "Waiting for connections...";
        }
    }

    function triggerSyncSpin() {
        const idx = Math.floor(Math.random() * players.length);
        const task = tasks[Math.floor(Math.random() * tasks.length)];
        rotation += (360 * 5) + (360 - (rotation % 360)) + (idx * (360/players.length));
        const d = { type:'spin', rot:rotation, idx:idx, t:task };
        bcast(d); runSpin(d);
    }

    function runSpin(d) {
        document.getElementById('resultBox').style.display='none';
        document.getElementById('playerActions').innerHTML = "";
        document.getElementById('bottle').style.transform = `rotate(${d.rot}deg)`;
        if(isHost) document.getElementById('spinBtn').disabled = true;

        setTimeout(() => {
            document.getElementById('vName').innerText = players[d.idx];
            document.getElementById('vTask').innerText = d.t;
            document.getElementById('resultBox').style.display='block';
            
            if(players[d.idx] === myName) {
                if(navigator.vibrate) navigator.vibrate([400, 100, 400]);
                document.getElementById('playerActions').innerHTML = `
                    <button class="btn" style="background:var(--wa-green); color:white;" onclick="postToWA('${d.t}')">üì§ POST PROOF TO GROUP</button>
                    <button class="btn" style="background:#444; color:white;" onclick="confirmDone()">DONE (NEXT ROUND)</button>
                `;
            }
        }, 4000);
    }

    function postToWA(t) {
        const msg = encodeURIComponent(`*BOTTLE SPIN CHALLENGE*\nüë§ Target: ${myName}\nüìù Task: ${t}\n\n‚úÖ STATUS: COMPLETED`);
        window.open(`${WA_GROUP_URL}?text=${msg}`);
    }

    function confirmDone() {
        const d = {type:'chat', u:'SYSTEM', m: `‚úÖ ${myName} completed the task!`};
        if(isHost) { bcast(d); unlockSpin(); } else { conn.send(d); conn.send({type:'unlock'}); }
        addMsg('SYSTEM', d.m);
        document.getElementById('playerActions').innerHTML = "Check WhatsApp for proof...";
    }

    function unlockSpin() { if(isHost) { document.getElementById('spinBtn').disabled = false; document.getElementById('spinPrompt').innerText = "Next Round Ready!"; } }
    function bcast(d) { conns.forEach(c => c.open && c.send(d)); }
    function toggleChat() { const p = document.getElementById('chatPanel'); p.style.display = p.style.display === 'flex' ? 'none' : 'flex'; }
    function sendChat() { 
        const i = document.getElementById('chatInput'); if(!i.value) return;
        const d = {type:'chat', u:myName, m:i.value};
        if(isHost) bcast(d); else conn.send(d);
        addMsg(myName, i.value); i.value = "";
    }
    function addMsg(u, m) { document.getElementById('msgContainer').innerHTML += `<div><b style="color:var(--gold)">${u}:</b> ${m}</div>`; }
    function sendInvite() { window.open(`https://wa.me/?text=${encodeURIComponent("*JOIN THE BOTTLE SPIN SESSION* üçæ\n" + window.location.origin + window.location.pathname + "?join=" + (peer ? peer.id.replace('fh-','') : ''))}`); }
    function resetGame() { if(confirm("Reset Room?")) { players=[myName]; activePlayers=[myName]; draw(); bcast({type:'sync', p:players, a:activePlayers}); } }

    window.onload = () => { if(new URLSearchParams(window.location.search).get('join')) initPlayer(new URLSearchParams(window.location.search).get('join')); };
</script>
</body>
</html>
